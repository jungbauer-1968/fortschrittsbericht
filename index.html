<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fortschrittsberichte ‚Äì √úbersicht</title>
  <style>
    :root {
      --bg: #f0f2f5;
      --card-bg: #ffffff;
      --primary: #d32f2f;
      --text-main: #222;
      --text-sub: #555;
      --border-subtle: #e0e0e0;
      --tile-low: #ffebee;
      --tile-mid: #fff8e1;
      --tile-high: #e8f5e9;
      --tile-low-border: #c62828;
      --tile-mid-border: #f9a825;
      --tile-high-border: #2e7d32;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text-main);
    }

    header {
      background: var(--primary);
      color: white;
      padding: 14px 16px;
      font-size: 20px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }

    header span.icon {
      font-size: 22px;
    }

    main {
      padding: 12px;
      max-width: 1100px;
      margin: 0 auto 40px auto;
    }

    .filterBox {
      background: var(--card-bg);
      padding: 12px 14px;
      border-radius: 10px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
      margin-bottom: 14px;
      font-size: 14px;
    }

    .filterBox-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .filterField {
      flex: 1 1 180px;
      min-width: 0;
    }

    .filterField label {
      display: block;
      margin-bottom: 4px;
      font-weight: 600;
      font-size: 13px;
    }

    .filterField select {
      width: 100%;
      padding: 9px 10px;
      font-size: 14px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    .hint {
      font-size: 12px;
      color: var(--text-sub);
      margin-top: 6px;
    }

    .card {
      background: var(--card-bg);
      border-radius: 14px;
      padding: 14px 16px 16px 16px;
      margin-top: 14px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      animation: fadeIn 0.25s ease;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }

    .card-title {
      font-size: 17px;
      font-weight: 700;
      margin-bottom: 3px;
    }

    .card-sub {
      font-size: 13px;
      color: var(--text-sub);
    }

    .overall-progress {
      margin-top: 4px;
      font-size: 13px;
      font-weight: 600;
    }

    .overall-bar {
      width: 100%;
      height: 10px;
      border-radius: 999px;
      overflow: hidden;
      background: #ddd;
      margin-top: 4px;
    }

    .overall-bar-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #ffb300, #2e7d32);
      transition: width 0.3s ease;
    }

    .section-title {
      margin-top: 14px;
      margin-bottom: 6px;
      font-size: 14px;
      font-weight: 700;
      color: var(--text-main);
      border-bottom: 1px solid var(--border-subtle);
      padding-bottom: 3px;
    }

    .tile-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(145px, 1fr));
      gap: 8px;
      margin-top: 6px;
    }

    .tile {
      border-radius: 10px;
      padding: 6px 8px 8px 8px;
      font-size: 12px;
      border: 1px solid var(--border-subtle);
      background: #fafafa;
    }

    .tile.low {
      background: var(--tile-low);
      border-color: var(--tile-low-border);
    }
    .tile.mid {
      background: var(--tile-mid);
      border-color: var(--tile-mid-border);
    }
    .tile.high {
      background: var(--tile-high);
      border-color: var(--tile-high-border);
    }

    .tile-label {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .tile-value {
      font-size: 13px;
      margin-bottom: 2px;
    }

    .tile-bar {
      width: 100%;
      height: 6px;
      border-radius: 999px;
      overflow: hidden;
      background: rgba(0, 0, 0, 0.1);
    }

    .tile-bar-fill {
      height: 100%;
      width: 0%;
      background: rgba(0, 0, 0, 0.35);
      transition: width 0.3s ease;
    }

    .text-block {
      font-size: 13px;
      margin-top: 5px;
    }

    .text-label {
      font-weight: 600;
      display: block;
      margin-bottom: 2px;
    }

    .text-content {
      white-space: pre-wrap;
      color: var(--text-sub);
    }

    .badge-problem {
      background: #ffebee;
      color: #b71c1c;
      border: 1px solid #ef5350;
      padding: 6px 8px;
      border-radius: 8px;
      font-size: 13px;
      margin-top: 10px;
    }

    .badge-info {
      background: #e3f2fd;
      color: #0d47a1;
      border: 1px solid #64b5f6;
      padding: 6px 8px;
      border-radius: 8px;
      font-size: 13px;
      margin-top: 6px;
    }

    .photo-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .photo-thumb-wrapper {
      width: 70px;
      height: 70px;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.3);
      background: #eee;
    }

    .photo-thumb {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .no-data {
      font-size: 13px;
      text-align: center;
      color: var(--text-sub);
      margin-top: 20px;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(6px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @media (max-width: 600px) {
      main {
        padding: 10px;
      }
      .card {
        padding: 12px 12px 14px 12px;
      }
      .card-header {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <header>
    <span class="icon">üõ†Ô∏è</span>
    Fortschrittsberichte
  </header>

  <main>
    <div class="filterBox">
      <div class="filterBox-row">
        <div class="filterField">
          <label for="projectFilter">Baustelle ausw√§hlen:</label>
          <select id="projectFilter">
            <option value="">Alle Baustellen</option>
          </select>
        </div>
        <div class="filterField">
          <label for="monteurFilter">Monteur / Team ausw√§hlen:</label>
          <select id="monteurFilter">
            <option value="">Alle Monteure</option>
          </select>
        </div>
      </div>
      <div class="hint">
        Tipp: Am Handy Querformat drehen, dann siehst du mehr Kacheln nebeneinander.
      </div>
    </div>

    <div id="cards"></div>
    <div id="noData" class="no-data" style="display:none;">
      Noch keine Eintr√§ge vorhanden.
    </div>
  </main>

  <script>
    const SHEET_CSV_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vRn9sbmbzT81t1KJQalXVr1agr9E4WUXBOTKrwMWNGimD9CnbCXD2Z2WQzpDMZKl0GVQOKI8mELb3Y0/pub?output=csv";

    function parseCSV(text) {
      // einfache CSV-Variante ‚Äì funktioniert, solange keine Kommas in Antworten sind
      return text
        .trim()
        .split(/\r?\n/)
        .map((row) => row.split(","));
    }

    function findIndex(headers, needle) {
      needle = needle.toLowerCase();
      return headers.findIndex((h) => h.toLowerCase().includes(needle));
    }

    function toNumber(val) {
      if (!val) return 0;
      return (
        parseFloat(
          val.replace("%", "").replace(",", ".").replace(" ", "")
        ) || 0
      );
    }

    function getTileClass(value) {
      if (value <= 0) return "";
      if (value <= 33) return "low";
      if (value <= 66) return "mid";
      return "high";
    }

    function createTile(label, valueStr) {
      const value = toNumber(valueStr);
      const tile = document.createElement("div");
      tile.className = "tile " + getTileClass(value);

      const lbl = document.createElement("div");
      lbl.className = "tile-label";
      lbl.textContent = label;

      const val = document.createElement("div");
      val.className = "tile-value";
      val.textContent = valueStr || "-";

      const bar = document.createElement("div");
      bar.className = "tile-bar";

      const fill = document.createElement("div");
      fill.className = "tile-bar-fill";
      fill.style.width = Math.max(0, Math.min(value, 100)) + "%";

      bar.appendChild(fill);

      tile.appendChild(lbl);
      tile.appendChild(val);
      tile.appendChild(bar);

      return tile;
    }

    function renderGroup(card, title, headersList, row, headerMap) {
      const relevant = headersList.filter((key) => headerMap[key] !== undefined);
      if (!relevant.length) return;

      const secTitle = document.createElement("div");
      secTitle.className = "section-title";
      secTitle.textContent = title;
      card.appendChild(secTitle);

      const grid = document.createElement("div");
      grid.className = "tile-grid";

      relevant.forEach((key) => {
        const idx = headerMap[key];
        const value = row[idx] || "";
        const prettyLabel = key.replace(" (%)", "").replace("  ", " ");
        grid.appendChild(createTile(prettyLabel, value));
      });

      card.appendChild(grid);
    }

    function driveLinkToImage(link) {
      // versucht, aus einem Drive-Link eine direkte Bild-URL zu machen
      if (!link) return null;
      const idMatch = link.match(/(?:id=|\/d\/)([a-zA-Z0-9_-]+)/);
      if (idMatch) {
        return "https://drive.google.com/uc?export=view&id=" + idMatch[1];
      }
      return link; // sonst einfach direkt versuchen
    }

    async function loadData() {
      const res = await fetch(SHEET_CSV_URL);
      const text = await res.text();
      const rows = parseCSV(text);

      if (!rows.length) return;

      const headers = rows[0];
      const data = rows.slice(1).filter((r) => r.some((c) => c.trim() !== ""));

      const cardsContainer = document.getElementById("cards");
      const noData = document.getElementById("noData");
      const filterMonteur = document.getElementById("monteurFilter");
      const filterProject = document.getElementById("projectFilter");

      const idxProjekt = findIndex(headers, "projekt/ baustelle");
      const idxDatum = findIndex(headers, "datum");
      const idxMonteur = findIndex(headers, "monteur");
      const idxWoche = findIndex(headers, "woche / zeitraum");
      const idxAllgAngaben = findIndex(headers, "allgemeine angaben");
      const idxBeschreibung = findIndex(headers, "beschreibung / details");
      const idxProbleme = findIndex(headers, "probleme / verz√∂gerungen");
      const idxKoord = findIndex(headers, "koordination mit anderen gewerken");
      const idxBest√§tigung = findIndex(headers, "best√§tigung name monteur");
      const idxFotos = findIndex(headers, "fotos");

      const percentIndexes = headers
        .map((h, i) => (h.includes("(%)") ? i : -1))
        .filter((i) => i >= 0);

      const headerMap = {};
      headers.forEach((h, i) => {
        headerMap[h.trim()] = i;
      });

      // Filter-Optionen
      const monteure = [
        ...new Set(
          data
            .map((r) => (idxMonteur >= 0 ? r[idxMonteur] : ""))
            .filter(Boolean)
        ),
      ].sort();

      monteure.forEach((m) => {
        const opt = document.createElement("option");
        opt.value = m;
        opt.textContent = m;
        filterMonteur.appendChild(opt);
      });

      const projekte = [
        ...new Set(
          data
            .map((r) => (idxProjekt >= 0 ? r[idxProjekt] : ""))
            .filter(Boolean)
        ),
      ].sort();

      projekte.forEach((p) => {
        const opt = document.createElement("option");
        opt.value = p;
        opt.textContent = p;
        filterProject.appendChild(opt);
      });

      const GROUPS = {
        "Baustelleneinrichtung & Vorbereitung": [
          "Baustelleneinrichtung (%)",
          "Allgemeinkosten (%)",
        ],
        Installation: [
          "Zuleitung & Z√§hlerpl√§tze (%)",
          "Rohr- und Tragsysteme (%)",
          "Kabel & Leitungen (%)",
          "Schalt- und Steckger√§te (%)",
          "NSP Verteilung (%)",
          "Demontagen & Montagen (%)",
          "Kabel einziehen (%)",
          "Planung / Inbetriebnahme (%)",
          "Tiefgarage (%)",
          "Rohinstallation ‚Äì Decke (%)",
          "Rohinstallation ‚Äì W√§nde (%)",
        ],
        Beleuchtung: [
          "Beleuchtungsk√∂rper (%)",
          "Au√üenbeleuchtung (%)",
          "Leuchten (%)",
        ],
        "PV-Anlage": ["PV-Anlage (%)"],
        "Sicherheit & Kommunikation": [
          "Brandrauchmelder (%)",
          "Erdung & Blitzschutz (%)",
          "Kommunikationsanlagen (%)",
          "Sprechanlage (%)",
          "Gegensprechanlage (%)",
          "Antennenanlage (%)",
        ],
        Dokumentation: ["Dokumentation / Inbetriebnahme (%)"],
      };

      // F√ºr etwas bessere Sortierung: nach Projekt, dann Datum (Textsortierung reicht erstmal)
      const sortedData = [...data].sort((a, b) => {
        const pa = idxProjekt >= 0 ? a[idxProjekt] : "";
        const pb = idxProjekt >= 0 ? b[idxProjekt] : "";
        if (pa < pb) return -1;
        if (pa > pb) return 1;
        const da = idxDatum >= 0 ? a[idxDatum] : "";
        const db = idxDatum >= 0 ? b[idxDatum] : "";
        return da < db ? -1 : da > db ? 1 : 0;
      });

      function render() {
        cardsContainer.innerHTML = "";
        let count = 0;
        const selMonteur = filterMonteur.value;
        const selProject = filterProject.value;

        sortedData.forEach((row) => {
          if (selMonteur && row[idxMonteur] !== selMonteur) return;
          if (selProject && row[idxProjekt] !== selProject) return;

          const card = document.createElement("article");
          card.className = "card";

          const headerDiv = document.createElement("div");
          headerDiv.className = "card-header";

          const titleBlock = document.createElement("div");
          const title = document.createElement("div");
          title.className = "card-title";
          title.textContent =
            (idxProjekt >= 0 && row[idxProjekt]) || "Unbekannte Baustelle";

          const sub = document.createElement("div");
          sub.className = "card-sub";
          const datum = idxDatum >= 0 ? row[idxDatum] : "";
          const monteur = idxMonteur >= 0 ? row[idxMonteur] : "";
          const woche = idxWoche >= 0 ? row[idxWoche] : "";
          sub.textContent = [datum, monteur, woche].filter(Boolean).join(" ‚Äì ");

          titleBlock.appendChild(title);
          titleBlock.appendChild(sub);

          headerDiv.appendChild(titleBlock);
          card.appendChild(headerDiv);

          // Gesamtfortschritt
          if (percentIndexes.length) {
            const values = percentIndexes.map((i) => toNumber(row[i]));
            const sum = values.reduce((a, b) => a + b, 0);
            const avg = Math.round(sum / percentIndexes.length) || 0;

            const overallLabel = document.createElement("div");
            overallLabel.className = "overall-progress";
            overallLabel.textContent = `Gesamtfortschritt: ${avg}%`;

            const bar = document.createElement("div");
            bar.className = "overall-bar";

            const fill = document.createElement("div");
            fill.className = "overall-bar-fill";
            fill.style.width = Math.max(0, Math.min(avg, 100)) + "%";

            bar.appendChild(fill);
            card.appendChild(overallLabel);
            card.appendChild(bar);
          }

          // Gruppen
          Object.entries(GROUPS).forEach(([groupTitle, cols]) =>
            renderGroup(card, groupTitle, cols, row, headerMap)
          );

          // Allgemeine Angaben
          if (idxAllgAngaben >= 0 && row[idxAllgAngaben]) {
            const block = document.createElement("div");
            block.className = "text-block";
            block.innerHTML =
              '<span class="text-label">Allgemeine Angaben:</span>' +
              `<div class="text-content">${row[idxAllgAngaben]}</div>`;
            card.appendChild(block);
          }

          // Beschreibung / Details
          if (idxBeschreibung >= 0 && row[idxBeschreibung]) {
            const block = document.createElement("div");
            block.className = "text-block";
            block.innerHTML =
              '<span class="text-label">Beschreibung / Details:</span>' +
              `<div class="text-content">${row[idxBeschreibung]}</div>`;
            card.appendChild(block);
          }

          // Probleme / Verz√∂gerungen
          if (idxProbleme >= 0 && row[idxProbleme]) {
            const warn = document.createElement("div");
            warn.className = "badge-problem";
            warn.innerHTML =
              "<strong>‚ö† Verz√∂gerungen / Probleme:</strong><br>" +
              row[idxProbleme];
            card.appendChild(warn);
          }

          // Koordination
          if (idxKoord >= 0 && row[idxKoord]) {
            const info = document.createElement("div");
            info.className = "badge-info";
            info.innerHTML =
              "<strong>Koordination mit anderen Gewerken:</strong><br>" +
              row[idxKoord];
            card.appendChild(info);
          }

          // Fotos
          if (idxFotos >= 0 && row[idxFotos]) {
            const secTitle = document.createElement("div");
            secTitle.className = "section-title";
            secTitle.textContent = "Fotos / Nachweise";
            card.appendChild(secTitle);

            const photoGrid = document.createElement("div");
            photoGrid.className = "photo-grid";

            const raw = row[idxFotos];
            const parts = raw.split(/\s+/).filter((p) =>
              p.startsWith("http")
            );

            parts.forEach((link) => {
              const imgSrc = driveLinkToImage(link);
              const wrapper = document.createElement("a");
              wrapper.href = link;
              wrapper.target = "_blank";
              wrapper.className = "photo-thumb-wrapper";

              const img = document.createElement("img");
              img.className = "photo-thumb";
              img.src = imgSrc;

              wrapper.appendChild(img);
              photoGrid.appendChild(wrapper);
            });

            if (parts.length === 0) {
              const none = document.createElement("div");
              none.style.fontSize = "12px";
              none.style.color = "#777";
              none.textContent = "Keine Fotos hochgeladen.";
              card.appendChild(none);
            } else {
              card.appendChild(photoGrid);
            }
          }

          // Best√§tigung Monteur
          if (idxBest√§tigung >= 0 && row[idxBest√§tigung]) {
            const block = document.createElement("div");
            block.className = "text-block";
            block.innerHTML =
              '<span class="text-label">Best√§tigung Monteur:</span>' +
              `<div class="text-content">${row[idxBest√§tigung]}</div>`;
            card.appendChild(block);
          }

          cardsContainer.appendChild(card);
          count++;
        });

        noData.style.display = count ? "none" : "block";
      }

      filterMonteur.addEventListener("change", render);
      filterProject.addEventListener("change", render);
      render();
    }

    loadData().catch((err) => {
      console.error(err);
      const nd = document.getElementById("noData");
      nd.textContent = "Fehler beim Laden der Daten.";
      nd.style.display = "block";
    });
  </script>
</body>
</html>
