<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Fortschritt ‚Äì Monteur</title>

<style>
    body {
        margin: 0;
        padding: 15px;
        background: #f4f4f4;
        font-family: Arial, sans-serif;
    }
    h1 {
        text-align: center;
        margin-bottom: 20px;
        font-size: 24px;
    }
    .inputBox {
        background: #fff;
        padding: 15px;
        border-radius: 12px;
        max-width: 450px;
        margin: 0 auto 20px auto;
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    .inputBox label {
        font-weight: bold;
    }
    input {
        width: 100%;
        padding: 12px;
        font-size: 18px;
        border-radius: 8px;
        border: 1px solid #ccc;
        margin-top: 10px;
        box-sizing: border-box;
    }
    button {
        width: 100%;
        padding: 12px;
        margin-top: 12px;
        background: #007bff;
        border: none;
        border-radius: 8px;
        color: #fff;
        font-size: 18px;
        cursor: pointer;
    }
    button:hover {
        background: #005fcc;
    }
    #result h2 {
        margin-top: 0;
        margin-bottom: 12px;
    }
    .card {
        background: #fff;
        padding: 15px;
        border-radius: 12px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        margin-bottom: 15px;
    }
    .title {
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 4px;
    }
    .subtitle {
        font-size: 14px;
        color: #777;
        margin-bottom: 10px;
    }
    .badge-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 8px;
        margin-bottom: 10px;
    }
    .badge {
        padding: 8px;
        font-size: 13px;
        border-radius: 7px;
        text-align: center;
        font-weight: bold;
        color: #fff;
    }
    .red { background: #d9534f; }
    .yellow { background: #f0ad4e; }
    .green { background: #5cb85c; }
    .warnbox {
        background: #ffdddd;
        border-left: 5px solid #cc0000;
        padding: 10px;
        border-radius: 5px;
        margin-top: 10px;
        color: #700;
        font-size: 14px;
    }
    .photogrid {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 10px;
    }
    .photogrid img {
        width: 75px;
        height: 75px;
        border-radius: 6px;
        object-fit: cover;
        border: 2px solid #ddd;
        cursor: pointer;
    }
    .hint {
        font-size: 13px;
        color: #555;
        margin-top: 6px;
    }
</style>
</head>

<body>

<h1>üë∑ Fortschritt ‚Äì Monteur</h1>

<div id="inputSection" class="inputBox">
    <label for="nameInput">Bitte Nachnamen eingeben:</label>
    <input id="nameInput" type="text" placeholder="z.B. Haindl" />
    <button onclick="start()">Weiter</button>
    <div class="hint">
        Tipp: Nur Nachname eintragen (z.B. <strong>Fazlic</strong>, <strong>Alex</strong>).
        Gro√ü/Klein ist egal.
    </div>
</div>

<div id="result"></div>

<script>
// CSV-Link aus deinem Google Sheet
const CSV =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vRn9sbmbzT81t1KJQalXVr1agr9E4WUXBOTKrwMWNGimD9CnbCXD2Z2WQzpDMZKl0GVQOKI8mELb3Y0/pub?output=csv";

let SHEET_HEADERS = [];
let SHEET_ROWS = [];
let INDEXES = {};

function normalize(str) {
  return (str || "").toString().trim().toLowerCase();
}

async function loadSheetIfNeeded() {
  if (SHEET_ROWS.length > 0) return;

  const res = await fetch(CSV);
  const text = await res.text();
  const rows = text.split(/\r?\n/).map(r => r.split(","));

  SHEET_HEADERS = rows[0];
  SHEET_ROWS = rows.slice(1).filter(r => r.some(v => v && v.trim() !== ""));

  INDEXES.projekt = SHEET_HEADERS.indexOf("Projekt/ Baustelle");
  INDEXES.datum = SHEET_HEADERS.indexOf("Datum");
  INDEXES.monteur = SHEET_HEADERS.indexOf("Monteur / Team");
  INDEXES.fotos = SHEET_HEADERS.indexOf("Fotos");
  INDEXES.probleme = SHEET_HEADERS.indexOf("Probleme / Verz√∂gerungen");

  INDEXES.prozent = SHEET_HEADERS
    .map((h, i) => (h.includes("(%)") ? i : -1))
    .filter(i => i >= 0);
}

async function start() {
  const input = document.getElementById("nameInput").value;
  const cleanInput = normalize(input);

  if (!cleanInput || cleanInput.length < 2) {
    alert("Bitte deinen Nachnamen eingeben (mindestens 2 Buchstaben).");
    return;
  }

  document.getElementById("inputSection").style.display = "none";
  await loadSheetIfNeeded();
  renderForMonteur(cleanInput);
}

function renderForMonteur(cleanName) {
  const result = document.getElementById("result");
  result.innerHTML = "<h2>‚õë Deine Baustellen</h2>";

  const idxM = INDEXES.monteur;
  if (idxM < 0) {
    result.innerHTML += "<p>Fehler: Spalte 'Monteur / Team' nicht gefunden.</p>";
    return;
  }

  // alle Eintr√§ge dieses Monteurs (fehlertolerant)
  const matches = SHEET_ROWS.filter(row => {
    const monteurRaw = row[idxM];
    const monteurNorm = normalize(monteurRaw);
    return monteurNorm.includes(cleanName);
  });

  if (matches.length === 0) {
    result.innerHTML +=
      "<p>Keine Eintr√§ge gefunden. Schau, ob dein Nachname im Formular gleich geschrieben ist.</p>";
    return;
  }

  // nach Projekt gruppieren
  const idxP = INDEXES.projekt;
  const idxD = INDEXES.datum;
  const idxF = INDEXES.fotos;
  const idxProb = INDEXES.probleme;
  const percentIdx = INDEXES.prozent || [];

  const projMap = {};
  matches.forEach(row => {
    const proj = (idxP >= 0 && row[idxP]) || "Ohne Projekt";
    if (!projMap[proj]) projMap[proj] = [];
    projMap[proj].push(row);
  });

  Object.keys(projMap).forEach(projekt => {
    const list = projMap[projekt];

    // nach Datum sortieren (neuester zuerst)
    list.sort((a, b) => {
      const da = idxD >= 0 ? new Date(a[idxD]) : new Date(0);
      const db = idxD >= 0 ? new Date(b[idxD]) : new Date(0);
      return db - da;
    });

    const row = list[0]; // letzter Eintrag

    const card = document.createElement("div");
    card.className = "card";

    const datum = idxD >= 0 ? row[idxD] : "";
    const monteur = idxM >= 0 ? row[idxM] : "";

    card.innerHTML += `
      <div class="title">${projekt}</div>
      <div class="subtitle">${datum} ‚Äì ${monteur}</div>
    `;

    // Prozent-Badges
    const grid = document.createElement("div");
    grid.className = "badge-grid";

    percentIdx.forEach(i => {
      const label = SHEET_HEADERS[i].replace("(%)", "");
      let val = parseInt((row[i] || "0").replace("%", ""), 10);
      if (isNaN(val)) val = 0;

      let color = val <= 33 ? "red" : val <= 66 ? "yellow" : "green";

      const b = document.createElement("div");
      b.className = `badge ${color}`;
      b.textContent = `${label.trim()} ${val}%`;
      grid.appendChild(b);
    });

    card.appendChild(grid);

    // Probleme
    if (idxProb >= 0 && row[idxProb] && row[idxProb].trim() !== "") {
      const warn = document.createElement("div");
      warn.className = "warnbox";
      warn.innerHTML =
        "‚ö†Ô∏è <strong>Probleme / Verz√∂gerungen:</strong><br>" + row[idxProb];
      card.appendChild(warn);
    }

    // Fotos
    if (idxF >= 0 && row[idxF] && row[idxF].includes("http")) {
      const links = row[idxF].split(" ").filter(l => l.includes("http"));
      if (links.length > 0) {
        const pg = document.createElement("div");
        pg.className = "photogrid";

        links.forEach(link => {
          const img = document.createElement("img");
          img.src = link.replace("open?", "thumbnail?");
          img.onclick = () => window.open(link, "_blank");
          pg.appendChild(img);
        });

        card.appendChild(pg);
      }
    }

    result.appendChild(card);
  });
}
</script>
</body>
</html>
